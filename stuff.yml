---
- import_role:
    name: aws
  vars:
    dns_record_list:
    - name: "{{ private_dns }}.{{ private_domain }}"
      zone: "{{ private_domain }}"
      type: A
      value: "{{ private_ip }}"
      private: true
      ttl: 120
  tags: configuration

- include_role:
    name: grafana
  tags: grafana
  vars:
    mimir_memberlist:
      join_members: "{{ mimir_memberlist_join_members }}"
      advertise_addr: "{{ private_ip }}"
      abort_if_cluster_join_fails: false

- name: Install Alloy
  include_role:
    name: alloy
  tags: alloy
  vars:
    env_file_vars:
      CUSTOM_ARGS: "--server.http.listen-addr=0.0.0.0:12345"
    config: |
      loki.write "local" {
        endpoint {
          url = "http://loki.opinion-stg.local:3100/loki/api/v1/push"
        }
      }

      loki.relabel "journal" {
        forward_to = []

        rule {
          source_labels = ["__journal__systemd_unit"]
          target_label  = "unit"
        }
        rule {
          source_labels = ["__journal__boot_id"]
          target_label  = "boot_id"
        }
        rule {
          source_labels = ["__journal__transport"]
          target_label  = "transport"
        }
        rule {
          source_labels = ["__journal_priority_keyword"]
          target_label  = "level"
        }
        rule {
          source_labels = ["__journal__hostname"]
          target_label  = "instance"
        }
      }

      loki.source.journal "read" {
        forward_to = [
          loki.write.local.receiver,
        ]
        relabel_rules = loki.relabel.journal.rules
        labels = {
          "job" = "integrations/node_exporter",
        }
      }
